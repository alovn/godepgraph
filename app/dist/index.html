<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>GoDepGraph</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <style>
        #graph{
            width: 100%;
            height: 100%;
            text-align: center;
            margin-top: 8px;
        }
        #btnWrap{
            position: fixed;
            top: 5px;
            right: 5px;
            user-select:none;
        }
        #btnWrap span{
            cursor: pointer;
        }
        #btnWrap span.checked{
            color: blue;
        }
        #inputWrap{
            position:fixed;
            top: 5px;;
            left:50%;
            margin-left: -250px;
            width:500px;
            height:30px;
            line-height: 30px;
            text-align: center;
        }
        #inputWrap input {
            text-align: center;
            width: 400px;
            height:30px;
            line-height: 30px;
            color: gray;
        }
        #inputWrap button{
            height: 30px;
            line-height: 26px;
            vertical-align: middle;
        }
        .node_module{
            cursor:pointer;
        }
    </style>
</head>
<body>
    <div id="inputWrap">
        <input type="text" />
        <button type="button">rest</button>
    </div>
    <div id="graph"></div>
    <div id="btnWrap">
        <span>Show Std Library</span>
    </div>
    <!-- <script src="https://unpkg.com/d3@7.4.4/dist/d3.min.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm/dist/index.min.js" type="javascript/worker"></script>
    <script src="https://unpkg.com/d3-graphviz@4.1.1/build/d3-graphviz.js"></script>
    <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.js"></script> -->

    <script src="js/d3.min.js"></script>
    <script src="js/wasm.min.js" type="javascript/worker"></script>
    <script src="js/d3-graphviz.js"></script>
    <script src="js/jquery.js"></script>
    <script>
        function loadData(showStdLib, pkg, callback) {
            $.get("/graph?std="+showStdLib+"&pkg="+pkg).then(function(res, textStatus, jqXHR){
                d3.select("#graph")
                    .graphviz({
                        width: window.innerWidth-30,
                        height: window.innerHeight-30,
                        fit: true,
                        zoom: true,
                    })
                    .transition(function () {
                        return d3.transition("main")
                            .ease(d3.easePolyInOut)
                            .delay(200)
                            .duration(300);
                    })
                    .dot(res)
                    .render()
                    .on("end", interactive);;

                    if(callback) {
                        callback()
                    }
                    //init
                    var pkg = jqXHR.getResponseHeader("X-Pkg")
                    var $input = $('#inputWrap input');
                    var inputValue = $input.val();
                    if(!inputValue && pkg) {
                        $input.val(pkg)
                    }
                    
            }).fail(function(err){
                console.log(err.responseText)
                alert(err.responseText);
            })
        }
        function interactive(){
            var nodes = d3.selectAll('.node_module');
            nodes.on("click", function(){
                var pkg = d3.select(this).selectAll('text').text();
                $('#inputWrap input').val(pkg);
                var checked = $('#btnWrap span').data('checked');
                loadData(!!checked, pkg, null);
            });
        }
        function switchStdLibBtn(){
            setTimeout(function(){
                var $btn = $('#btnWrap span');
                var old = $btn.data('checked');
                var showStdLib = !old;
                $btn.data('checked', showStdLib);
                if(showStdLib) {
                    $btn.addClass("checked").text("Hide Std Library");
                } else {
                    $btn.removeClass("checked").text("Show Std Library");;
                }
            },100);
        }
        
        $(function(){
            $('#inputWrap input').keypress(function(event){
                if(event.keyCode == 13) {
                    var checked = $('#btnWrap span').data('checked');
                    var pkg = $(this).val();
                    loadData(!!checked, pkg, null);
                }
            });
            //reset
            $('#inputWrap button').click(function(){
                $('#inputWrap input').val('');
                var checked = $('#btnWrap span').data('checked');
                loadData(!!checked, '', null);
            });
            $('#btnWrap span').click(function(){
                var checked = $(this).data('checked');
                var pkg = $('#inputWrap input').val();
                loadData(!checked, pkg, switchStdLibBtn);
            });
            $('#inputWrap input').focus();
            loadData(false, "", null)
        });
    </script>
</body>
</html>